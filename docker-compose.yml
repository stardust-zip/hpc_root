services:
  # Service 1: hpc_dispatch_management (FastAPI)
  dispatch_service:
    build:
      context: ./hpc_dispatch_management
      dockerfile: Dockerfile
    container_name: hpc_dispatch_service
    restart: unless-stopped
    ports:
      - "8888:8888"
    volumes:
      - ./hpc_dispatch_management/src:/app/src
    deploy:
      resources:
        limits:
          memory: 300M
    environment:
      - APP_ENV=local
      - NOTIFICATION_SERVICE_URL=http://sys_web/api/v1/events/publish
      - HPC_USER_SERVICE_URL=http://sys_web/api/v1
      - HPC_DRIVE_SERVICE_URL=http://hpc_drive:7777/api/v1/drive
      - DATABASE_URL=mysql+pymysql://root:root@shared_db:3306/hpc_dispatch
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGO=HS256
      - MOCK_AUTH_ENABLED=false
    depends_on:
      - shared_db
    networks:
      - hpc_shared_network

  # Service 2: hpc_drive (FastAPI)
  hpc_drive:
    build:
      context: ./hpc_drive
      dockerfile: Dockerfile
    container_name: hpc_drive_service
    command: uvicorn src.hpc_drive.main:app --host 0.0.0.0 --port 7777 --reload
    ports:
      - "7777:7777"
    volumes:
      - ./hpc_drive/src:/app/src
      - drive_data:/app/data
      - uploads_data:/app/src/hpc_drive/uploads
    deploy:
      resources:
        limits:
          memory: 300M
    environment:
      DATABASE_URL: "mysql+pymysql://root:root@shared_db:3306/hpc_drive"
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      - shared_db
    networks:
      - hpc_shared_network
    restart: unless-stopped

  # Service 3: LMS (Spring Boot)
  lms-app:
    build:
      context: ./LMS
      dockerfile: Dockerfile
      args:
        SKIP_TESTS: "true"
    container_name: lms-app
    restart: unless-stopped
    ports:
      - "8083:8083"
    deploy:
      resources:
        limits:
          memory: 700M
    environment:
      SERVER_PORT: 8083
      SPRING_PROFILES_ACTIVE: prod
      TZ: Asia/Ho_Chi_Minh
      # UPDATED: Points to shared_db
      SPRING_DATASOURCE_URL: jdbc:mysql://shared_db:3306/LMS?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Ho_Chi_Minh&characterEncoding=UTF-8
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      NOTIFICATION_SERVICE_URL: http://sys_web:80
      IDENTITY_SERVICE_URL: http://sys_web:80
      JWT_SECRET: ${JWT_SECRET}
    volumes:
      - ./LMS/uploads:/app/uploads
      - ./LMS/logs:/app/logs
    depends_on:
      shared_db:
        condition: service_healthy
    networks:
      - hpc_shared_network

  # Service 4: Module-Tuyendung (Laravel)
  tuyen_app:
    build:
      context: ./Module_Tuyendung/back-end
      dockerfile: Dockerfile
    container_name: module_tuyendung
    working_dir: /var/www/html
    deploy:
      resources:
        limits:
          memory: 512M
    environment:
      - APP_URL=${APP_URL_TUYEN}
      # UPDATED: Points to shared_db
      - DB_HOST=shared_db
      - JWT_SECRET=${JWT_SECRET}
      - DB_PORT=3306
      - DB_DATABASE=module_tuyendung
      - DB_USERNAME=root
      - DB_PASSWORD=root
    volumes:
      - ./Module_Tuyendung/back-end:/var/www/html
    networks:
      - hpc_shared_network
    depends_on:
      - shared_db

  tuyen_web:
    image: nginx:alpine
    container_name: backend_tuyendung
    ports:
      - "8020:80"
    deploy:
      resources:
        limits:
          memory: 128M
    volumes:
      - ./Module_Tuyendung/back-end:/var/www/html
      - ./Module_Tuyendung/back-end/nginx:/etc/nginx/conf.d:ro
    networks:
      - hpc_shared_network
    depends_on:
      - tuyen_app

  # Service 5: System-Management (Laravel)
  sys_app:
    build:
      context: ./System-Management
      dockerfile: Dockerfile
    container_name: hpc_app
    restart: unless-stopped
    working_dir: /var/www
    deploy:
      resources:
        limits:
          memory: 512M
    volumes:
      - ./System-Management:/var/www
    environment:
      - APP_URL=${APP_URL_SYS}
      # UPDATED: Points to shared_db
      - DB_HOST=shared_db
      - DB_PORT=3306
      - DB_DATABASE=system_services
      - DB_USERNAME=root
      - DB_PASSWORD=root
      - JWT_SECRET=${JWT_SECRET}
    networks:
      hpc_shared_network:
        aliases:
          - app
    depends_on:
      - shared_db

  sys_web:
    image: nginx:alpine
    container_name: hpc_web
    restart: unless-stopped
    ports:
      - "8082:80"
    deploy:
      resources:
        limits:
          memory: 128M
    volumes:
      - ./System-Management:/var/www
      - ./System-Management/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - sys_app
    networks:
      hpc_shared_network:
        aliases:
          - hpc_web

  sys_redis:
    image: redis:alpine
    container_name: hpc_redis
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
    ports:
      - "6380:6379"
    networks:
      hpc_shared_network:
        aliases:
          - redis

  sys_reverb:
    build:
      context: ./System-Management
      dockerfile: Dockerfile
    container_name: hpc_reverb
    command: php artisan reverb:start
    working_dir: /var/www
    deploy:
      resources:
        limits:
          memory: 256MB
    volumes:
      - ./System-Management:/var/www
    depends_on:
      - sys_app
      - sys_redis
    ports:
      - "8081:8080"
    networks:
      hpc_shared_network:
        aliases:
          - reverb

  sys_zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: hpc_zookeeper
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      KAFKA_OPTS: "-Xmx128m -Xms128m"
    ports:
      - "2181:2181"
    networks:
      hpc_shared_network:
        aliases:
          - zookeeper

  sys_kafka:
    image: confluentinc/cp-kafka:6.2.10
    container_name: hpc_kafka
    restart: unless-stopped
    depends_on:
      - sys_zookeeper
    ports:
      - "9092:9092"
    deploy:
      resources:
        limits:
          memory: 512M
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: sys_zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://hpc_kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
    networks:
      hpc_shared_network:
        aliases:
          - kafka

  sys_queue_worker:
    build:
      context: ./System-Management
      dockerfile: Dockerfile
    container_name: hpc_queue_worker
    restart: unless-stopped
    working_dir: /var/www
    deploy:
      resources:
        limits:
          memory: 512M
    volumes:
      - ./System-Management:/var/www
    command: php artisan queue:work --queue=default --verbose --tries=3 --timeout=90
    depends_on:
      - sys_app
      - sys_redis
    networks:
      - hpc_shared_network

  sys_kafka_consumer:
    build:
      context: ./System-Management
      dockerfile: Dockerfile
    container_name: hpc_kafka_consumer
    restart: unless-stopped
    working_dir: /var/www

    deploy:
      resources:
        limits:
          memory: 256M
    volumes:
      - ./System-Management:/var/www
    command: php artisan kafka:consume
    depends_on:
      - sys_app
      - sys_kafka
    networks:
      - hpc_shared_network

  # Service 6: fe-portal (Next.js)
  fe_portal:
    build:
      context: ./fe-portal
      dockerfile: Dockerfile
    container_name: fe_portal
    restart: unless-stopped
    ports:
      - "3001:3001"
    deploy:
      resources:
        limits:
          memory: 1G
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_REVERB_HOST=${NEXT_PUBLIC_REVERB_HOST}
      - STORAGE_SERVICE_URL=http://sys_web:80/api
      - NEXT_PUBLIC_REVERB_PORT=8082
      - NEXT_PUBLIC_REVERB_SCHEME=http
    volumes:
      - ./fe-portal:/app
      - /app/node_modules
    networks:
      - hpc_shared_network

  # Service 7: Shared Database 
  shared_db:
    image: mysql:8.0
    container_name: shared_mysql
    restart: unless-stopped
    command: --default-authentication-plugin=mysql_native_password
    deploy:
      resources:
        limits:
          memory: 1.5G
    environment:
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3306:3306"
    volumes:
      - shared_db_data:/var/lib/mysql
      - ./create_dbs.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - hpc_shared_network
    healthcheck:
      test:
        ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Service 8: Db Gate
  dbgate:
    image: dbgate/dbgate
    container_name: hpc_dbgate
    restart: always
    ports:
      - "8067:3000"
    networks:
      - hpc_shared_network

networks:
  hpc_shared_network:
    driver: bridge

volumes:
  drive_data:
  uploads_data:
  shared_db_data:
