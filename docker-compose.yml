services:
  # ==============================================================================
  # SERVICE 1: HPC DISPATCH MANAGEMENT (Python)
  # ==============================================================================
  dispatch_service:
    build:
      context: ./hpc_dispatch_management
      dockerfile: Dockerfile
    container_name: hpc_dispatch_service
    restart: unless-stopped
    ports:
      - "8888:8888"
    volumes:
      - ./hpc_dispatch_management/src:/app/src
      - ./hpc_dispatch_management/hpc_dispatch.db:/app/hpc_dispatch.db
    environment:
      # Pointing to System Management Web (sys_web) for notifications/auth
      - NOTIFICATION_SERVICE_URL=http://sys_web/api/v1/events/publish
      - DATABASE_URL=sqlite:///./hpc_dispatch.db
      - HPC_USER_SERVICE_URL=http://sys_web/api/v1
      # Pointing to HPC Drive service
      - HPC_DRIVE_SERVICE_URL=http://hpc_drive:7777/api/v1/drive
    networks:
      - hpc_shared_network

  # ==============================================================================
  # SERVICE 2: HPC DRIVE (Python)
  # ==============================================================================
  hpc_drive:
    build:
      context: ./hpc_drive
      dockerfile: Dockerfile
    container_name: hpc_drive_service
    ports:
      - "7777:7777"
    volumes:
      - drive_data:/app/data
      - uploads_data:/app/src/hpc_drive/uploads
    environment:
      DATABASE_URL: "sqlite:////app/data/drive.db"
      # Pointing to System Management Web
      AUTH_SERVICE_ME_URL: "http://sys_web:80/api/v1/me"
    networks:
      - hpc_shared_network
    restart: unless-stopped

  # ==============================================================================
  # SERVICE 3: LMS (Java/Spring Boot)
  # ==============================================================================
  lms_mysql:
    image: mysql:8.0
    container_name: lms-mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: LMS
      MYSQL_ROOT_PASSWORD: abc123-
      MYSQL_USER: lms_user
      MYSQL_PASSWORD: lms_password
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "3308:3306" # Mapped to 3308 to avoid conflict with System-Mgmt (3307) or Host (3306)
    volumes:
      - lms_mysql_data:/var/lib/mysql
      - ./LMS/docker/mysql/init:/docker-entrypoint-initdb.d:ro
      - ./LMS/docker/mysql/conf.d:/etc/mysql/conf.d:ro
    networks:
      - hpc_shared_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pabc123-"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    command: 
      - --default-authentication-plugin=mysql_native_password
      - --max_connections=200

  lms-app:
    build:
      context: ./LMS
      dockerfile: Dockerfile
      args:
        SKIP_TESTS: "true"
    container_name: lms-app
    restart: unless-stopped
    ports:
      - "8083:8083"
    environment:
      SERVER_PORT: 8083
      SPRING_PROFILES_ACTIVE: prod
      TZ: Asia/Ho_Chi_Minh
      # Database connection (Using service name lms_mysql)
      SPRING_DATASOURCE_URL: jdbc:mysql://lms_mysql:3306/LMS?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Ho_Chi_Minh&characterEncoding=UTF-8
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: abc123-
      # External Services (Pointing to System Management)
      NOTIFICATION_SERVICE_URL: http://sys_web:80
      IDENTITY_SERVICE_URL: http://sys_web:80
    volumes:
      - ./LMS/uploads:/app/uploads
      - ./LMS/logs:/app/logs
    depends_on:
      lms_mysql:
        condition: service_healthy
    networks:
      - hpc_shared_network

  # ==============================================================================
  # SERVICE 4: MODULE TUYENDUNG (PHP/Laravel)
  # ==============================================================================
  tuyen_app:
    build:
      context: ./Module_Tuyendung/back-end
      dockerfile: Dockerfile
    container_name: module_tuyendung
    working_dir: /var/www/html
    environments:
      - APP_URL=${APP_URL_TUYEN}
    volumes:
      - ./Module_Tuyendung/back-end:/var/www/html
    networks:
      - hpc_shared_network
    depends_on:
      - tuyen_db

  tuyen_web:
    image: nginx:alpine
    container_name: backend_tuyendung
    ports:
      - "8020:80"
    volumes:
      - ./Module_Tuyendung/back-end:/var/www/html
      - ./Module_Tuyendung/back-end/nginx:/etc/nginx/conf.d:ro
    networks:
      - hpc_shared_network
    depends_on:
      - tuyen_app

  tuyen_db:
    image: mysql:8.0
    container_name: mysql_tuyendung
    restart: always
    environment:
      MYSQL_DATABASE: module_tuyendung
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3309:3306"
    volumes:
      - tuyen_db_data:/var/lib/mysql
    networks:
      - hpc_shared_network

  # ==============================================================================
  # SERVICE 5: SYSTEM MANAGEMENT (Core - PHP/Laravel)
  # ==============================================================================
  sys_app:
    build:
      context: ./System-Management
      dockerfile: Dockerfile
    container_name: hpc_app
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - ./System-Management:/var/www
    environments:
      - APP_URL=${APP_URL_SYS}
      - DB_HOST=sys_db
    networks:
      hpc_shared_network:
        aliases:
          - app # Crucial: Allows Nginx to find this service as "app" defined in nginx.conf

  sys_web:
    image: nginx:alpine
    container_name: hpc_web
    restart: unless-stopped
    ports:
      - "8082:80"
    volumes:
      - ./System-Management:/var/www
      - ./System-Management/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - sys_app
    networks:
      hpc_shared_network:
        aliases:
          - hpc_web # Crucial: Allows other services (Drive, Dispatch) to find this as http://hpc_web

  sys_db:
    image: mysql:8.0
    container_name: hpc_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: system_services
      MYSQL_USER: system_services
      MYSQL_PASSWORD: hpc123
    ports:
      - "3307:3306"
    volumes:
      - sys_db_data:/var/lib/mysql
    networks:
      - hpc_shared_network

  sys_redis:
    image: redis:alpine
    container_name: hpc_redis
    restart: unless-stopped
    ports:
      - "6380:6379"
    networks:
      hpc_shared_network:
        aliases:
          - redis # Allows Laravel to connect via host: redis

  sys_reverb:
    build:
      context: ./System-Management
      dockerfile: Dockerfile
    container_name: hpc_reverb
    command: php artisan reverb:start
    working_dir: /var/www
    volumes:
      - ./System-Management:/var/www
    depends_on:
      - sys_app
      - sys_redis
    ports:
      - "8081:8080"
    networks:
      - hpc_shared_network

  sys_zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: hpc_zookeeper
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      hpc_shared_network:
        aliases:
          - zookeeper

  sys_kafka:
    image: confluentinc/cp-kafka:6.2.10
    container_name: hpc_kafka
    restart: unless-stopped
    depends_on:
      - sys_zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: sys_zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://hpc_kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
    networks:
      hpc_shared_network:
        aliases:
          - kafka

  sys_queue:
    build:
      context: ./System-Management
      dockerfile: Dockerfile
    container_name: hpc_queue
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - ./System-Management:/var/www
    command: php artisan queue:work --queue=emails --verbose --tries=3 --timeout=90
    depends_on:
      - sys_app
      - sys_redis
    networks:
      - hpc_shared_network

  sys_queue_default:
    build:
      context: ./System-Management
      dockerfile: Dockerfile
    container_name: hpc_queue_default
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - ./System-Management:/var/www
    command: php artisan queue:work --verbose --tries=3 --timeout=90
    depends_on:
      - sys_app
      - sys_redis
    networks:
      - hpc_shared_network

  sys_kafka_consumer:
    build:
      context: ./System-Management
      dockerfile: Dockerfile
    container_name: hpc_kafka_consumer
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - ./System-Management:/var/www
    command: php artisan kafka:consume
    depends_on:
      - sys_app
      - sys_kafka
    networks:
      - hpc_shared_network

  # ==============================================================================
  # SERVICE 6: FRONTEND PORTAL (Next.js)
  # ==============================================================================
  fe_portal:
    build:
      context: ./fe-portal
      dockerfile: Dockerfile
    container_name: fe_portal
    restart: unless-stopped
    ports:
      - "3000:3001" 
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_REVERB_HOST=${NEXT_PUBLIC_REVERB_HOST}
      - STORAGE_SERVICE_URL=http://sys_web:80/api
      - NEXT_PUBLIC_REVERB_PORT=8082
      - NEXT_PUBLIC_REVERB_SCHEME=http
    volumes:
      # Bind Mount for live editing
      - ./fe-portal:/app
      - /app/node_modules
    networks:
      - hpc_shared_network

# ==============================================================================
# GLOBAL VOLUMES & NETWORKS
# ==============================================================================
networks:
  hpc_shared_network:
    driver: bridge

volumes:
  drive_data:
  uploads_data:
  lms_mysql_data:
  tuyen_db_data:
  sys_db_data:
